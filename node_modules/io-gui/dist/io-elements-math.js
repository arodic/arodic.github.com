import{IoGl,chunk,IoThemeSingleton,IoLayerSingleton}from"./io-elements-core.js";import{IoElement,html}from"./io.js";class IoVector extends IoElement{static get Style(){return html`<style>:host {display: flex;flex-direction: row;align-self: stretch;justify-self: stretch;}:host > io-number {width: inherit;flex: 1 1;}:host > io-number:not(:last-child) {margin-right: var(--io-spacing);}:host > .io-slot {display: flex;flex: 0 0 auto;}:host > .io-slot > * {flex: 0 0 auto;}</style>`}static get Properties(){return{value:[0,0,0,0],conversion:1,step:.01,min:-1/0,max:1/0,linkable:!1,linked:!1,_c:[0,1]}}_onValueSet(e){const t=e.composedPath()[0].id;if(null!==t){const i=e.detail.value,a=e.detail.oldValue;if(this.value[t]=i,this.linked){const e=i/a;for(let n in this._c){const o=this._c[n];0===a?this.value[o]=i:o!==t&&(this.value[o]*=e)}}const n={object:this.value,prop:this.linked?null:t,value:i,oldValue:a};this.dispatchEvent("object-mutated",n,!1,window)}}valueChanged(){this._c=this.value instanceof Array?[0,1,2,3]:["x","y","z","w"]}insertTrailingElement(){}changed(){const e=[];for(let t in this._c){const i=this._c[t];void 0!==this.value[i]&&e.push(["io-number",{id:i,value:this.value[i],conversion:this.conversion,step:this.step,min:this.min,max:this.max,ladder:!0,"on-value-set":this._onValueSet}])}e.push(["div",{id:"slot",class:"io-slot"},[this.getSlotted()]]),this.template(e)}getSlotted(){return this.linkable?["io-boolean",{display:"icon",value:this.bind("linked"),trueicon:"icons:link",falseicon:"icons:unlink"}]:null}}IoVector.Register();class IoMatrix extends IoElement{static get Style(){return html`<style>:host {display: grid;align-self: stretch;justify-self: stretch;grid-gap: var(--io-spacing);}:host[columns="4"] {grid-template-columns: repeat(4, 1fr);}:host[columns="3"] {grid-template-columns: repeat(3, 1fr);}:host[columns="2"] {grid-template-columns: repeat(2, 1fr);}:host > io-number {width: inherit;}</style>`}static get Attributes(){return{columns:4}}static get Properties(){return{value:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],step:.001,_c:Array}}_onValueSet(e){if(e.detail.object)return;const t=e.composedPath()[0].id;if(null!==t){const i=e.detail.value,a=e.detail.oldValue;this.value[t]=i;const n={object:this.value,prop:t,value:i,oldValue:a};this.dispatchEvent("object-mutated",n,!1,window)}}valueChanged(){let e;4===this.value.length&&(e=[0,1,2,3],this.columns=2),9===this.value.length&&(e=[0,1,2,3,4,5,6,7,8],this.columns=3),16===this.value.length&&(e=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],this.columns=4),this._c=e}changed(){const e=[];for(let t in this._c){const i=this._c[t];void 0!==this.value[i]&&e.push(["io-number",{id:i,value:this.value[i],step:this.step,"on-value-set":this._onValueSet}])}this.template(e)}}IoMatrix.Register();class IoHsva extends IoVector{static get Properties(){return{value:[1,1,1,1],min:0,max:1,step:.01}}valueChanged(){this._c=this.value instanceof Array?[0,1,2,3]:["h","s","v","a"]}getSlotted(){return["io-hsva-swatch",{id:"swatch",value:this.value}]}}IoHsva.Register();class IoHsvaHue extends IoGl{static get Style(){return html`<style>:host {border-radius: var(--io-border-radius);border: var(--io-inset-border);min-width: var(--io-line-height);min-height: var(--io-line-height);cursor: ns-resize;}:host[horizontal] {cursor: ew-resize;}:host[aria-invalid] {border: var(--io-border-error);}:host:focus {outline: 0;border-color: var(--io-color-focus);}</style>`}static get Attributes(){return{role:"slider",tabindex:0}}static get Properties(){return{value:[.5,.5,.5,1],horizontal:{value:!1,reflect:1}}}static get Frag(){return`\n      varying vec2 vUv;\n\n      ${chunk.hue2rgb}\n      ${chunk.hsv2rgb}\n\n      void main(void) {\n\n        float axis = (uHorizontal == 1) ? vUv.x : vUv.y;\n\n        // Hue spectrum\n        vec3 final = hsv2rgb(vec3(axis, 1.0, 1.0));\n\n        // Hue marker\n        float lineWidth = 4.0;\n      \tfloat hueMarkerOffset = abs(axis - uValue[0]) * ((uHorizontal == 1) ? uSize.x : uSize.y);\n        float dist = hueMarkerOffset - lineWidth;\n        float dist2 = hueMarkerOffset - (lineWidth + 1.0);\n        final = mix(final, cssColor.rgb, saturate(1.0 - dist2));\n        final = mix(final, cssBackgroundColor.rgb, saturate(1.0 - dist));\n\n        gl_FragColor = vec4(final, 1.0);\n      }\n    `}static get Listeners(){return{touchstart:"_onTouchstart",mousedown:"_onMousedown",keydown:"_onKeydown"}}valueChanged(){this._c=this.value instanceof Array?[0,1,2,3]:["h","s","v","a"]}_onTouchstart(e){e.preventDefault(),this.addEventListener("touchmove",this._onTouchmove),this.addEventListener("touchend",this._onTouchend),this._onPointerdown(e),this.focus()}_onTouchmove(e){e.preventDefault(),this._onPointermove(e)}_onTouchend(){this.removeEventListener("touchmove",this._onTouchmove),this.removeEventListener("touchend",this._onTouchend)}_onMousedown(e){e.preventDefault(),this.focus(),window.addEventListener("mousemove",this._onMousemove),window.addEventListener("mouseup",this._onMouseup),this._onPointerdown(e)}_onMousemove(e){this._onPointermove(e)}_onMouseup(){window.removeEventListener("mousemove",this._onMousemove),window.removeEventListener("mouseup",this._onMouseup)}disconnectedCallback(){super.disconnectedCallback(),window.removeEventListener("mousemove",this._onMousemove),window.removeEventListener("mouseup",this._onMouseup)}_onPointerdown(e){this._onPointermove(e)}_onPointermove(e){const t=e.changedTouches?e.changedTouches[0]:e,i=this.getBoundingClientRect(),a=Math.max(0,Math.min(1,(t.clientX-i.x)/i.width)),n=Math.max(0,Math.min(1,(t.clientY-i.y)/i.height));this._setHSVA(a,n),this.dispatchEvent("object-mutated",{object:this.value},!1,window),this.dispatchEvent("value-set",{property:"value",value:this.value},!1),this.changed()}_setHSVA(e,t){this.value[this._c[0]]=Math.max(0,Math.min(1,this.horizontal?e:1-t))}}IoHsvaHue.Register();class IoHsvaSv extends IoHsvaHue{static get Style(){return html`<style>:host {cursor: move;}</style>`}static get Frag(){return`\n      varying vec2 vUv;\n\n      ${chunk.hue2rgb}\n      ${chunk.hsv2rgb}\n      ${chunk.translate}\n\n      void main(void) {\n\n        float tileSize = uSize.x / 32.0;\n        tileSize = max(1.0, tileSize - mod(tileSize, 1.0));\n        tileSize *= 5.0;\n        vec2 alphaPos = floor(vUv * vec2(tileSize, tileSize / uAspect));\n        float alphaMask = mod(alphaPos.x + mod(alphaPos.y, 2.0), 2.0);\n        vec3 alphaPattern = mix(vec3(0.5), vec3(1.0), alphaMask);\n\n        vec3 currentColor = hsv2rgb(uValue.xyz);\n\n        vec3 final = alphaPattern;\n\n        float markerSize = 18.0;\n\n        // SV gradient\n        final = hsv2rgb(vec3(uValue[0], vUv.x, vUv.y));\n\n        // Color marker\n        float offset = length((vUv - vec2(uValue[1], uValue[2])) * uSize);\n\n        float lineWidth = 4.0;\n\n        float distOut = (offset - (markerSize - lineWidth));\n        float distIn = 1.0 - (offset - (markerSize + lineWidth));\n        float dist = saturate(min(distOut, distIn));\n\n        float distOut2 = (offset - (markerSize - (lineWidth + 1.0)));\n        float distIn2 = 1.0 - (offset - (markerSize + (lineWidth + 1.0)));\n        float dist2 = saturate(min(distOut2, distIn2));\n\n        currentColor = mix(alphaPattern, saturate(currentColor), saturate(uValue.a));\n\n        final = mix(final, currentColor, saturate(distIn));\n        final = mix(final, cssColor.rgb, dist2);\n        final = mix(final, cssBackgroundColor.rgb, dist);\n\n        gl_FragColor = vec4(final, 1.0);\n      }\n    `}_setHSVA(e,t){this.value[this._c[1]]=Math.max(0,Math.min(1,e)),this.value[this._c[2]]=Math.max(0,Math.min(1,1-t))}}IoHsvaSv.Register();class IoHsvaAlpha extends IoHsvaHue{static get Frag(){return`\n      varying vec2 vUv;\n\n      ${chunk.hue2rgb}\n      ${chunk.hsv2rgb}\n\n      void main(void) {\n\n        float tileSize = uSize.x / 32.0;\n        tileSize = max(1.0, tileSize - mod(tileSize, 1.0));\n        tileSize *= 5.0;\n        vec2 alphaPos = floor(vUv * vec2(tileSize, tileSize / uAspect));\n        float alphaMask = mod(alphaPos.x + mod(alphaPos.y, 2.0), 2.0);\n        vec3 alphaPattern = mix(vec3(0.5), vec3(1.0), alphaMask);\n\n        vec3 currentColor = saturate(hsv2rgb(uValue.xyz));\n\n        vec3 final = alphaPattern;\n\n        float axis = (uHorizontal == 1) ? vUv.x : vUv.y;\n\n        // Apha gradient\n        final = mix(alphaPattern, currentColor, axis);\n\n        // Apha marker\n        float lineWidth = 4.0;\n      \tfloat hueMarkerOffset = abs(axis - uValue[3]) * ((uHorizontal == 1) ? uSize.x : uSize.y);\n        float dist = hueMarkerOffset - lineWidth;\n        float dist2 = hueMarkerOffset - (lineWidth + 1.0);\n        final = mix(final, cssColor.rgb, saturate(1.0 - dist2));\n        final = mix(final, cssBackgroundColor.rgb, saturate(1.0 - dist));\n\n        gl_FragColor = vec4(final, 1.0);\n      }\n    `}valueChanged(){super.valueChanged();const e=void 0!==this.value[this._c[3]];this.setAttribute("aria-invalid",!e&&"true")}_setHSVA(e,t){void 0!==this.value[this._c[3]]&&(this.value[this._c[3]]=Math.max(0,Math.min(1,this.horizontal?e:1-t)))}}IoHsvaAlpha.Register();class IoHsvaPicker extends IoElement{static get Style(){return html`<style>:host {${IoThemeSingleton.panel}}:host {display: flex;cursor: move;align-items: stretch;min-width: var(--io-line-height);min-height: var(--io-line-height);flex-direction: column;}:host[horizontal] {flex-direction: row;}:host > io-hsva-sv {flex: 1 1;}:host > *:not(:last-child) {margin: 0 0 var(--io-spacing) 0;}:host[horizontal] > *:not(:last-child) {margin: 0 var(--io-spacing) 0 0;}</style>`}static get Attributes(){return{horizontal:!0}}static get Properties(){return{expanded:{type:Boolean,reflect:1},value:[.5,.5,.5,1]}}changed(){const e=void 0!==this.value[3]||void 0!==this.value.a;this.template([["io-hsva-sv",{value:this.value}],["io-hsva-hue",{value:this.value,horizontal:!this.horizontal}],e?["io-hsva-alpha",{value:this.value,horizontal:!this.horizontal}]:null])}}IoHsvaPicker.Register(),IoHsvaPicker.singleton=new IoHsvaPicker,IoLayerSingleton.appendChild(IoHsvaPicker.singleton),IoHsvaPicker.singleton.addEventListener("expanded-changed",IoLayerSingleton.onChildExpanded);class IoHsvaSwatch extends IoGl{static get Style(){return html`<style>:host {cursor: pointer;border-radius: var(--io-border-radius);border: var(--io-inset-border);width: calc(var(--io-line-height) + calc(2 * var(--io-spacing)));height: calc(var(--io-line-height) + calc(2 * var(--io-spacing)));}:host[aria-invalid] {outline: 1px solid var(--io-color-focus);}:host:focus {outline: 1px solid var(--io-color-focus);}</style>`}static get Attributes(){return{role:"slider",tabindex:0}}static get Properties(){return{value:[.5,.5,.5,.5],horizontal:!1}}static get Frag(){return`\n      varying vec2 vUv;\n\n      ${chunk.hue2rgb}\n      ${chunk.hsv2rgb}\n\n      void main(void) {\n        float tileSize = uSize.x / 32.0;\n        tileSize = max(1.0, tileSize - mod(tileSize, 1.0));\n        tileSize *= 5.0;\n        vec2 alphaPos = floor(vUv * vec2(tileSize, tileSize / uAspect));\n        float alphaMask = mod(alphaPos.x + mod(alphaPos.y, 2.0), 2.0);\n        vec3 alphaPattern = mix(vec3(0.5), vec3(1.0), alphaMask);\n\n        float alpha = uValue.a;\n        vec2 pxUv = vUv * uSize;\n        float lineWidth = 4.0;\n        if (pxUv.x < lineWidth) alpha = 1.0;\n        if (pxUv.y < lineWidth) alpha = 1.0;\n        if (pxUv.x > uSize.x - lineWidth) alpha = 1.0;\n        if (pxUv.y > uSize.y - lineWidth) alpha = 1.0;\n\n        gl_FragColor = vec4(mix(alphaPattern, hsv2rgb(uValue.xyz), saturate(alpha)), 1.0);\n      }\n    `}static get Listeners(){return{mousedown:"_onMousedown",keydown:"_onKeydown"}}_onMousedown(){event.preventDefault(),this.focus(),this._expand()}_onKeydown(){this._expand()}_expand(){const e=void 0!==this.value[3]||void 0!==this.value.a;IoHsvaPicker.singleton.value=this.value,IoHsvaPicker.singleton.style.width=e?"192px":"160px",IoHsvaPicker.singleton.style.height="128px",IoHsvaPicker.singleton.expanded=!0,IoLayerSingleton.clickblock=!0,IoLayerSingleton.srcElement=this,IoLayerSingleton.setElementPosition(IoHsvaPicker.singleton,"bottom",this.getBoundingClientRect())}}IoHsvaSwatch.Register();class IoRgba extends IoVector{static get Style(){return html`<style>:host > io-number:nth-child(1) {border-bottom-color: red;}:host > io-number:nth-child(2) {border-bottom-color: green;}:host > io-number:nth-child(3) {border-bottom-color: blue;}</style>`}static get Properties(){return{value:[1,1,1,1],min:0,max:1,step:.01}}valueChanged(){this._c=this.value instanceof Array?[0,1,2,3]:["r","g","b","a"]}getSlotted(){return["io-rgba-swatch",{id:"swatch",value:this.value}]}}function rgb2hsv(e,t,i){const a=Math.max(e,t,i),n=Math.min(e,t,i);let o,s,l=a,r=a-n;if(s=0==a?0:r/a,a==n)o=0;else{switch(a){case e:o=(t-i)/r+(t<i?6:0);break;case t:o=(i-e)/r+2;break;case i:o=(e-t)/r+4}o/=6}return[o,s,l]}function hsv2rgb(e,t,i){const a=Math.floor(6*e),n=6*e-a,o=i*(1-t),s=i*(1-n*t),l=i*(1-(1-n)*t);switch(a%6){case 0:return[i,l,o];case 1:return[s,i,o];case 2:return[o,i,l];case 3:return[o,s,i];case 4:return[l,o,i];case 5:return[i,o,s]}}IoRgba.Register();class IoRgbaPicker extends IoHsvaPicker{valueChanged(){this._c=this.value instanceof Array?[0,1,2,3]:["r","g","b","a"]}_onValueSet(e){const t=this._c,i=e.detail.value,a=hsv2rgb(i[0],i[1],i[2]),n=void 0!==this.value[t[3]];this.value[t[0]]=a[0],this.value[t[1]]=a[1],this.value[t[2]]=a[2],n&&(this.value[t[3]]=i[3]),this._suspendLoop=!0,this.dispatchEvent("object-mutated",{object:this.value},!1,window),setTimeout(()=>{this._suspendLoop=!1})}changed(){if(this._suspendLoop)return;const e=this._c,t=rgb2hsv(this.value[e[0]],this.value[e[1]],this.value[e[2]]),i=void 0!==this.value[e[3]];this._hsva=[...t,i?this.value[e[3]]:1],this.template([["io-hsva-sv",{value:this._hsva,"on-value-set":this._onValueSet}],["io-hsva-hue",{value:this._hsva,horizontal:!this.horizontal,"on-value-set":this._onValueSet}],i?["io-hsva-alpha",{value:this._hsva,horizontal:!this.horizontal,"on-value-set":this._onValueSet}]:null])}}IoRgbaPicker.Register(),IoRgbaPicker.singleton=new IoRgbaPicker,IoLayerSingleton.appendChild(IoRgbaPicker.singleton),IoRgbaPicker.singleton.addEventListener("expanded-changed",IoLayerSingleton.onChildExpanded);class IoRgbaSwatch extends IoGl{static get Style(){return html`<style>:host {cursor: pointer;border-radius: var(--io-border-radius);border: var(--io-inset-border);width: calc(var(--io-line-height) + calc(2 * var(--io-spacing)));height: calc(var(--io-line-height) + calc(2 * var(--io-spacing)));}:host[aria-invalid] {outline: 1px solid var(--io-color-focus);}:host:focus {outline: 1px solid var(--io-color-focus);}</style>`}static get Attributes(){return{role:"slider",tabindex:0}}static get Properties(){return{value:[.5,.5,.5,.5],horizontal:!1}}static get Frag(){return"\n      varying vec2 vUv;\n\n      void main(void) {\n        float tileSize = uSize.x / 32.0;\n        tileSize = max(1.0, tileSize - mod(tileSize, 1.0));\n        tileSize *= 5.0;\n        vec2 alphaPos = floor(vUv * vec2(tileSize, tileSize / uAspect));\n        float alphaMask = mod(alphaPos.x + mod(alphaPos.y, 2.0), 2.0);\n        vec3 alphaPattern = mix(vec3(0.5), vec3(1.0), alphaMask);\n\n        float alpha = uValue.a;\n        vec2 pxUv = vUv * uSize;\n        float lineWidth = 4.0;\n        if (pxUv.x < lineWidth) alpha = 1.0;\n        if (pxUv.y < lineWidth) alpha = 1.0;\n        if (pxUv.x > uSize.x - lineWidth) alpha = 1.0;\n        if (pxUv.y > uSize.y - lineWidth) alpha = 1.0;\n\n        gl_FragColor = vec4(mix(alphaPattern, uValue.rgb, saturate(alpha)), 1.0);\n      }\n    "}static get Listeners(){return{mousedown:"_onMousedown",keydown:"_onKeydown"}}_onMousedown(){event.preventDefault(),this.focus(),this._expand()}_onKeydown(){this._expand()}_expand(){const e=void 0!==this.value[3]||void 0!==this.value.a;IoRgbaPicker.singleton.value=this.value,IoRgbaPicker.singleton.style.width=e?"192px":"160px",IoRgbaPicker.singleton.style.height="128px",IoRgbaPicker.singleton.expanded=!0,IoLayerSingleton.clickblock=!0,IoLayerSingleton.srcElement=this,IoLayerSingleton.setElementPosition(IoRgbaPicker.singleton,"bottom",this.getBoundingClientRect())}}IoRgbaSwatch.Register();export{IoHsva,IoHsvaAlpha,IoHsvaHue,IoHsvaPicker,IoHsvaSv,IoHsvaSwatch,IoMatrix,IoRgba,IoRgbaPicker,IoRgbaSwatch,IoVector};