import{IoLayerSingleton,IoItem}from"./io-elements-core.js";import{IoElement,html,filterObject}from"./io.js";let lastFocus=null;function _onWindowFocusIn(){lastFocus=document.activeElement}window.addEventListener("focusin",_onWindowFocusIn,{capture:!1});class IoMenuLayer extends IoElement{static get Style(){return html`<style>:host {display: block;visibility: hidden;position: fixed;top: 0;left: 0;bottom: 0;right: 0;z-index: 100000;user-select: none;overflow: hidden;pointer-events: none;touch-action: none;}:host[expanded] {visibility: visible;pointer-events: all;}:host > io-menu-options {position: absolute;transform: translate3d(0, 0, 0);top: 0;left: 0;max-width: 90vw !important;}:host io-menu-item:hover {background-color: inherit;}:host io-menu-item:focus {background-color: var(--io-background-color-light);}</style>`}static get Attributes(){return{expanded:{value:!1,notify:!0}}}static get Properties(){return{lastFocus:HTMLElement,$options:Array}}static get Listeners(){return{mousedown:"_onMousedown",mousemove:"_onMousemove",mouseup:"_onMouseup",touchstart:"_onTouchstart",touchmove:"_onTouchmove",touchend:"_onTouchend",contextmenu:"_onContextmenu"}}constructor(t){super(t),this._menuRoot=null,this._hoveredItem=null,this._hoveredOptions=null,this._startAnimation=this._startAnimation.bind(this),this._stopAnimation=this._stopAnimation.bind(this),this._x=0,this._y=0,this._v=0,this.addEventListener("focusin",this._onFocusIn,{capture:!0})}_onFocusIn(){if(lastFocus){const t=lastFocus.$parent&&lastFocus.$parent.parentElement===this;this.lastFocus=t?this.lastFocus:lastFocus}}connectedCallback(){super.connectedCallback(),window.addEventListener("scroll",this._onWindowScroll,{capture:!0}),window.addEventListener("wheel",this._onWindowScroll,{capture:!0})}disconnectedCallback(){super.disconnectedCallback(),window.removeEventListener("scroll",this._onWindowScroll,{capture:!0}),window.removeEventListener("wheel",this._onWindowScroll,{capture:!0}),this._stopAnimation()}registerOptions(t){this.$options.push(t),clearTimeout(this.__timeout),this.__timeout=setTimeout(()=>{this.$options.sort((t,e)=>t._depth<e._depth?-1:1)})}unregisterOptions(t){this.$options.splice(this.$options.indexOf(t),1)}collapseAll(){for(let t=this.$options.length;t--;)this.$options[t].parentElement===this&&(this.$options[t].expanded=!1);this.expanded=!1}collapseSiblings(t){const e=this._getParentOptions(t);for(let t=this.$options.length;t--;)-1===e.indexOf(this.$options[t])&&this.$options[t].parentElement===this&&(this.$options[t].expanded=!1)}_onOptionsExpanded(t){const e=t.$parent,o=e.$parent&&e.$parent.parentElement===this;this._menuRoot=o?this._menuRoot:e,this.expanded=!!this.$options.find(t=>t.parentElement===this&&t.expanded)}_onWindowScroll(){this.expanded&&this.collapseAll()}_onMousedown(t){t.preventDefault(),this._onPointerdown(t),this._onPointermove(t)}_onMousemove(t){t.preventDefault(),this._onPointermove(t)}_onMouseup(t){t.preventDefault(),this._onPointerup(t)}_onTouchstart(t){t.preventDefault(),this._onPointerdown(t.changedTouches[0]),this._onPointermove(t.changedTouches[0])}_onTouchmove(t){t.preventDefault(),this._onPointermove(t.changedTouches[0])}_onTouchend(t){t.preventDefault(),this._onPointerup(t)}_onContextmenu(t){t.preventDefault(),this.collapseAll()}_onPointerdown(t){this._x=t.clientX,this._y=t.clientY,this._hoveredItem?this.lastFocus===this._hoveredItem&&this.lastFocus.expanded&&this.collapseAll():this.collapseAll()}_onPointermove(t){const e=t.clientX-this._x,o=t.clientY-this._y;this._v=(2*this._v+Math.abs(o)-Math.abs(e))/3,this._x=t.clientX,this._y=t.clientY;let n=this.$options;for(let t=n.length;t--;)if(n[t].expanded){let e=n[t].getBoundingClientRect();if(e.top<this._y&&e.bottom>this._y&&e.left<this._x&&e.right>this._x){this._hoveredOptions=n[t];let e=n[t].querySelectorAll("io-menu-item");for(let o=e.length;o--;){const i=this._getParentOptions(e[o]);let s=e[o].getBoundingClientRect();if(-1!==i.indexOf(this._menuRoot)&&s.top<this._y&&s.bottom>this._y&&s.left<this._x&&s.right>this._x){let i=n[t].horizontal;return this._focusItem(e[o],i),void(this._hoveredItem=e[o])}}return n[t]}}if(this.lastFocus){let t=this.lastFocus.getBoundingClientRect();if(t.top<this._y&&t.bottom>this._y&&t.left<this._x&&t.right>this._x)return this._hoveredItem=this.lastFocus,void this._focusItem(this._hoveredItem)}this._hoveredOptions=null,this._hoveredItem=null}_focusItem(t,e){if(t!==this.__prevItem){const o=100;clearTimeout(this.__timeoutOpen),clearTimeout(this.__timeoutReset),this._v>1||t.parentNode!==this.__prevParent||e?(this.__prevItem=t,this._hoveredItem=t,"function"==typeof t._toggleExpanded&&(t._toggleExpanded(!0),t.focus(),this.collapseSiblings(t))):this.__timeoutOpen=setTimeout(function(){this.__prevItem=t,this._hoveredItem=t,"function"==typeof t._toggleExpanded&&(t._toggleExpanded(!0),t.focus(),this.collapseSiblings(t))}.bind(this),o),this.__prevParent=t.parentNode,this.__timeoutReset=setTimeout(function(){this.__prevItem=null,this.__prevParent=null}.bind(this),o+1)}}_onPointerup(t){if(this._hoveredItem){const e=!this._hoveredItem._options;"touchend"===t.type&&this._hoveredItem._onClick&&(t.preventDefault(),this._hoveredItem._onClick(t)),e&&this.collapseAll()}else this._hoveredOptions||this.collapseAll()}_getParentOptions(t){const e=[];t.$options&&e.push(t.$options);let o=t.$parent;for(;o;)e.push(o),o=o.$parent;return e}_moveHovered(){let t=this._hoveredOptions;if(t){let e=t.getBoundingClientRect();if(e.height>window.innerHeight){if(this._y<100&&e.top<0){let o=(100-this._y)/5e3,n=e.top;t._y=t._y-Math.ceil(n*o)+1}else if(this._y>window.innerHeight-100&&e.bottom>window.innerHeight){let o=(100-(window.innerHeight-this._y))/5e3,n=e.bottom-window.innerHeight;t._y=t._y-Math.ceil(n*o)-1}t.style.left=t._x+"px",t.style.top=t._y+"px"}}}_startAnimation(){this._moveHovered(),this._rAF_ID=requestAnimationFrame(this._startAnimation)}_stopAnimation(){this._rAF_ID&&cancelAnimationFrame(this._rAF_ID)}expandedChanged(){this.expanded?this._startAnimation():(this._hoveredItem=null,this._hoveredOptions=null,this._stopAnimation(),setTimeout(()=>{if(this.lastFocus){let t=this.lastFocus.getBoundingClientRect();t.bottom>0&&t.top<window.innerHeight&&t.right>0&&t.left<window.innerWidth&&this.lastFocus.focus(),this.lastFocus=null}}))}}IoMenuLayer.Register(),IoMenuLayer.singleton=new IoMenuLayer,document.body.appendChild(IoMenuLayer.singleton);class IoMenuOptions extends IoElement{static get Style(){return html`<style>:host {display: flex;flex-direction: column;white-space: nowrap;user-select: none;touch-action: none;background: var(--io-background-color-light);color: var(--io-color);border-radius: var(--io-border-radius);border: var(--io-outset-border);border-color: var(--io-outset-border-color);box-shadow: var(--io-shadow);}:host:not([horizontal]) {padding: calc(2 * var(--io-spacing)) 0;}:host:not([expanded]) {visibility: hidden;}:host[horizontal] {flex-direction: row;align-self: stretch;justify-self: stretch;flex-wrap: nowrap;}:host[horizontal] > * {padding: calc(2 * var(--io-spacing)) calc(4 * var(--io-spacing));}:host:not([horizontal]) > io-menu-item > * {min-width: 0.5em;padding: 0 var(--io-spacing);}:host[horizontal] > io-menu-item > .io-menu-hint,:host[horizontal] > io-menu-item > .io-menu-more {display: none;}:host[horizontal] > io-menu-item.io-hamburger {margin-left: auto;}:host[horizontal] > io-menu-item.io-hamburger[hidden] {display: inline-block;width: 0;padding: 0;border: 0;overflow: hidden;visibility: hidden;}</style>`}static get Attributes(){return{role:"listbox",expanded:{value:!0,notify:!0},overflow:{type:Boolean,notify:!0},horizontal:{type:Boolean,notify:!0}}}static get Properties(){return{options:Array,position:"right",value:{value:null,notify:!0},slotted:Array,$parent:HTMLElement,_depth:0,_rects:Array}}static get Listeners(){return{"io-menu-item-clicked":"_onMenuItemClicked"}}connectedCallback(){super.connectedCallback(),IoMenuLayer.singleton.registerOptions(this)}disconnectedCallback(){super.disconnectedCallback(),IoMenuLayer.singleton.unregisterOptions(this)}_onMenuItemClicked(t){const e=t.composedPath()[0];e!==this&&(t.stopImmediatePropagation(),this.set("value",t.detail.value),this.dispatchEvent("io-menu-item-clicked",t.detail,!0),e.expanded=!1)}onResized(){this.setOverflow()}setOverflow(){const t=this.querySelectorAll("io-menu-item:not(.io-hamburger)");if(this.horizontal){const e=this.querySelector(".io-hamburger"),o=this._rects;if(o.length=t.length,!o.length)return;if(!t.length)return;let n=this.getBoundingClientRect().right,i=!1,s=1/0;e.hidden=!0;const h=[];for(let r=t.length;r--;){const a=t[r].getBoundingClientRect();o[r]=o[r]||{right:0,width:0},0!==a.right&&(o[r].right=a.right),0!==a.width&&(o[r].width=a.width),e.hidden&&i&&(e.hidden=!1,n-=e.getBoundingClientRect().width),t[r].selected?(n-=o[r].width,t[r].hidden=!1):(s=Math.min(s,o[r].right))<n?t[r].hidden=!1:(t[r].hidden=!0,h.push(t[r].option),i=!0)}e.option={options:h},this.overflow=i}else for(let e=t.length;e--;)t[e].hidden=!1}expandedChanged(){if(this.parentElement===IoMenuLayer.singleton&&(IoMenuLayer.singleton._onOptionsExpanded(this),this.expanded&&this.$parent)){let t=this.getBoundingClientRect(),e=this.$parent.getBoundingClientRect();const o=IoMenuLayer.singleton._x,n=IoMenuLayer.singleton._y;switch(this.position){case"pointer":IoLayerSingleton.nudgePointer(this,o,n,t);break;case"top":IoLayerSingleton.nudgeTop(this,e.x,e.top,t)||IoLayerSingleton.nudgeBottom(this,e.x,e.bottom,t)||IoLayerSingleton.nudgePointer(this,o,n,t);break;case"left":IoLayerSingleton.nudgeLeft(this,e.x,e.top,t)||IoLayerSingleton.nudgeRight(this,e.right,e.top,t)||IoLayerSingleton.nudgePointer(this,o,n,t);break;case"bottom":IoLayerSingleton.nudgeBottom(this,e.x,e.bottom,t)||IoLayerSingleton.nudgeTop(this,e.x,e.top,t)||IoLayerSingleton.nudgePointer(this,o,n,t);break;case"right":default:IoLayerSingleton.nudgeRight(this,e.right,e.top,t)||IoLayerSingleton.nudgeLeft(this,e.x,e.top,t)||IoLayerSingleton.nudgePointer(this,o,n,t)}}}changed(){const t=this.horizontal?"bottom":"right",e=[this.options.map(e=>["io-menu-item",{$parent:this,option:e,value:this.value,direction:t,_depth:this._depth+1}])];this.horizontal&&(e.splice(0,0,...this.slotted),e.push(["io-menu-item",{label:"☰",title:"select tab",value:this.value,class:"io-hamburger",_depth:this._depth}])),this.template(e),this.setOverflow()}}IoMenuOptions.Register();class IoMenuItem extends IoItem{static get Style(){return html`<style>:host {display: flex;flex: 0 0 auto;flex-direction: row;padding: var(--io-spacing);border-radius: 0;background: none;}:host > * {pointer-events: none;}:host > :not(:empty) {padding: 0 var(--io-spacing);}:host > .io-menu-icon {}:host > .io-menu-label {flex: 1 1 auto;overflow: hidden;text-overflow: ellipsis;}:host > .io-menu-hint {opacity: 0.25;}:host[hasmore]:after {content: '▸';}:host {border: var(--io-border-width) solid transparent;}:host[selected][direction="top"],:host[selected][direction="bottom"] {border-bottom-color: var(--io-color-link);}:host[selected][direction="right"],:host[selected][direction="left"] {border-left-color: var(--io-color-link);}</style>`}static get Attributes(){return{expanded:{value:!1,notify:!0},direction:{value:"bottom",notify:!0}}}static get Properties(){return{expanded:Boolean,option:Object,$parent:HTMLElement,$options:HTMLElement,_depth:0}}static get Listeners(){return{touchstart:"_onTouchstart",mousedown:"_onMousedown"}}_onMenuItemClicked(t){t.composedPath()[0]!==this&&(t.stopImmediatePropagation(),this.expanded=!1,this.set("value",t.detail.value),this.dispatchEvent("io-menu-item-clicked",t.detail,!0))}get _options(){if(this.option&&this.option.options&&this.option.options.length)return this.option.options}get _action(){if(this.option&&"function"==typeof this.option.action)return this.option.action}get _value(){return this.option&&void 0!==this.option.value?this.option.value:this.option&&"object"!=typeof this.option?this.option:void 0}get _icon(){if(this.option&&void 0!==this.option.icon)return this.option.icon}get _label(){return this.label?this.label:this.option&&void 0!==this.option.label?this.option.label:this.option&&void 0!==this.option.value?String(this.option.value):String(this.option)}get _hint(){if(this.option&&void 0!==this.option.hint)return this.option.hint}get _selected(){if(this.option&&(this.option.selected||this.option.value===this.value))return!0;if(this.value===this.option)return!0;const t=this._options;return!!t&&!!filterObject(t,t=>t===this.value||t.value===this.value)}connectedCallback(){super.connectedCallback(),this._updateOptions()}disconnectedCallback(){super.disconnectedCallback(),this._disconnectOptions(),this.removeEventListener("touchmove",this._onTouchmove),this.removeEventListener("touchend",this._onTouchend)}_connectOptions(){this.$options&&this.$options.parentElement!==IoMenuLayer.singleton&&IoMenuLayer.singleton.appendChild(this.$options)}_disconnectOptions(){this.$options&&this.$options.parentElement===IoMenuLayer.singleton&&IoMenuLayer.singleton.removeChild(this.$options)}_updateOptions(){this._options?this.$options?this.$options.setProperties({value:this.value,options:this._options||[],position:this.direction}):this.$options=new IoMenuOptions({$parent:this,expanded:this.bind("expanded"),value:this.value,options:this._options||[],position:this.direction,_depth:this._depth,"on-io-menu-item-clicked":this._onMenuItemClicked}):this._disconnectOptions()}_toggleExpanded(t){if(this._options){const e=void 0!==t?t:!this.expanded;e&&this._connectOptions(),this.expanded=e,IoMenuLayer.singleton._hoveredOptions=this.$options}else this.expanded=!1}_focusIn(){this.expanded&&setTimeout(()=>{this.$options.children.length&&this.$options.children[0].focus()})}_focusOut(){this.$parent&&this.$parent.$parent&&(this.$parent.expanded=!1,this.$parent.$parent.expanded=!1,this.$parent.$parent.focus())}_onMousedown(){IoMenuLayer.singleton._onMousedown(event),this._toggleExpanded(!0),this.focus()}_onTouchstart(t){t.cancelable&&(t.preventDefault(),this.addEventListener("touchmove",this._onTouchmove),this.addEventListener("touchend",this._onTouchend),IoMenuLayer.singleton._hoveredItem=this,IoMenuLayer.singleton._onTouchstart(t),this._toggleExpanded(!0),this.focus())}_onTouchmove(t){IoMenuLayer.singleton._onTouchmove(t)}_onTouchend(t){t.preventDefault(),this.removeEventListener("touchmove",this._onTouchmove),this.removeEventListener("touchend",this._onTouchend),IoMenuLayer.singleton._onTouchend(t)}_onKeydown(t){let e="";if("left"===this.direction||"right"===this.direction?("ArrowUp"===t.key&&(e="prev"),"ArrowRight"===t.key&&(e="in"),"ArrowDown"===t.key&&(e="next"),"ArrowLeft"===t.key&&(e="out")):("ArrowUp"===t.key&&(e="out"),"ArrowRight"===t.key&&(e="next"),"ArrowDown"===t.key&&(e="in"),"ArrowLeft"===t.key&&(e="prev")),"Tab"===t.key&&(e="next"),13===t.which||32===t.which)t.preventDefault(),this._options?(this._toggleExpanded(!0),this._focusIn()):this._onClick(t);else if("Escape"===t.key)t.preventDefault(),IoMenuLayer.singleton.collapseAll();else if(this.$parent&&this.$parent.parentElement===IoMenuLayer.singleton){const o=[...this.$parent.children],n=o.indexOf(this);switch(e&&t.preventDefault(),e){case"prev":this.expanded=!1,o[(n+o.length-1)%o.length].focus();break;case"next":this.expanded=!1,o[(n+1)%o.length].focus();break;case"in":this._focusIn();break;case"out":this.expanded=!1,this._focusOut()}}else this.expanded&&"in"===e?this._focusIn():(this.expanded=!1,super._onKeydown(t))}_onClick(t){this._action&&this._action.apply(null,[this._value]),void 0!==this._value&&(t.stopImmediatePropagation(),this.set("value",this._value,!0),this.dispatchEvent("io-menu-item-clicked",{value:this._value},!0),this.expanded=!1)}_onFocus(){super._onFocus(),this.$parent&&this.$parent.parentElement===IoMenuLayer.singleton&&this._toggleExpanded(!0)}expandedChanged(){this.expanded&&this.$parent&&!this.$parent.expanded&&console.warn("This should be expanded",this.$parent.expanded)}valueChanged(){this._updateOptions()}optionChanged(){this._updateOptions()}directionChanged(){this._updateOptions()}changed(){this.selected=this._selected,this.setAttribute("hasmore",this._options&&"right"===this.direction),this.template([["span",{class:"io-menu-icon"},this._icon],["span",{class:"io-menu-label"},this._label||String(this._value)],["span",{class:"io-menu-hint"},this._hint]])}}IoMenuItem.Register();class IoMenuOption extends IoMenuItem{static get Style(){return html`<style>:host {white-space: pre;display: inline-block;background-color: var(--io-background-color-dark);background-image: var(--io-gradient-button);border: var(--io-outset-border);border-color: var(--io-outset-border-color);border-radius: var(--io-border-radius);padding: var(--io-spacing);transition: background-color 0.4s;height: 1.375em;}:host:not([label])::after {content: '▾';padding-left: var(--io-spacing);}</style>`}static get Attributes(){return{role:"button"}}static get Properties(){return{options:Array,_depth:100}}static get Listeners(){return{"io-menu-item-clicked":"_onMenuItemClicked"}}get _options(){if(this.options&&this.options.length)return this.options}_onMenuItemClicked(t){const e=t.composedPath()[0];e!==this&&(t.stopImmediatePropagation(),this.set("value",t.detail.value),e.expanded=!1)}_onClick(t){IoMenuLayer.singleton._x=t.clientX,IoMenuLayer.singleton._y=t.clientY,this._toggleExpanded(!0)}_onKeydown(t){13===t.which||32===t.which?(t.preventDefault(),this._toggleExpanded(!0),this._focusIn()):"ArrowLeft"===t.key?(t.preventDefault(),IoMenuLayer.singleton.LastFocus=null,this.expanded=!1,this.focusTo("left")):"ArrowUp"===t.key?(t.preventDefault(),IoMenuLayer.singleton.LastFocus=null,this.expanded=!1,this.focusTo("up")):"ArrowRight"===t.key?(t.preventDefault(),IoMenuLayer.singleton.LastFocus=null,this.expanded=!1,this.focusTo("right")):"ArrowDown"===t.key&&(t.preventDefault(),IoMenuLayer.singleton.LastFocus=null,this.expanded?this._focusIn():this.focusTo("down"))}changed(){let t;if(this.options){const e=this.options.find(t=>t.value===this.value);e&&(t=e.label?e.label:"object"==typeof e.value?`${e.value.constructor.name}`+(e.value instanceof Array?`(${e.value.length})`:""):String(e.value))}t=this.label||t||String(this.value),this.textNode=t,this.title=t,this.setAttribute("aria-haspopup","listbox"),this.setAttribute("aria-expanded",String(this.expanded))}}IoMenuOption.Register();class IoMenu extends IoElement{static get Properties(){return{value:null,options:Array,expanded:Boolean,position:"pointer",button:0,$options:IoMenuOptions}}get compose(){return{$options:{$parent:this,expanded:this.bind("expanded"),options:this.options,position:this.position,"on-io-menu-item-clicked":this._onMenuItemClicked}}}connectedCallback(){super.connectedCallback(),this._parent=this.parentElement,this.parentElement.addEventListener("contextmenu",this._onContextmenu),this.parentElement.addEventListener("mousedown",this._onMousedown),this.parentElement.addEventListener("touchstart",this._onTouchstart),this.parentElement.style.userSelect="none"}disconnectedCallback(){super.disconnectedCallback(),this._parent.removeEventListener("contextmenu",this._onContextmenu),this._parent.removeEventListener("mousedown",this._onMousedown),this._parent.removeEventListener("touchstart",this._onTouchstart),this._parent.removeEventListener("touchmove",this._onTouchmove),this._parent.removeEventListener("touchend",this._onTouchend),this._disconnectOptions(),this._parent.style.userSelect=null}getBoundingClientRect(){return this.parentElement.getBoundingClientRect()}_connectOptions(){this.$options.parentElement!==IoMenuLayer.singleton&&IoMenuLayer.singleton.appendChild(this.$options)}_disconnectOptions(){this.$options.parentElement===IoMenuLayer.singleton&&IoMenuLayer.singleton.removeChild(this.$options)}_expand(){this.expanded=!0,IoMenuLayer.singleton._hoveredOptions=this.$options}_onMenuItemClicked(t){t.composedPath()[0]!==this&&(t.stopImmediatePropagation(),this.set("value",t.detail.value),this.dispatchEvent("io-menu-item-clicked",t.detail,!0),this.expanded=!1)}_onContextmenu(t){this.options.length&&2===this.button&&(this._connectOptions(),IoMenuLayer.singleton._onMousedown(t),this._expand())}_onMousedown(t){this.options.length&&t.button===this.button&&2!==t.button&&(this._connectOptions(),IoMenuLayer.singleton._onMousedown(t),this._expand())}_onTouchstart(t){this.options.length&&t.cancelable&&2!==this.button&&(this._connectOptions(),this.parentElement.addEventListener("touchmove",this._onTouchmove),this.parentElement.addEventListener("touchend",this._onTouchend),IoMenuLayer.singleton._onTouchstart(t),this._expand())}_onTouchmove(t){IoMenuLayer.singleton._onTouchmove(t)}_onTouchend(t){this.parentElement.removeEventListener("touchmove",this._onTouchmove),this.parentElement.removeEventListener("touchend",this._onTouchend),IoMenuLayer.singleton._onTouchend(t)}}IoMenu.Register();export{IoMenu,IoMenuItem,IoMenuLayer,IoMenuOption,IoMenuOptions};